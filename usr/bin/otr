#!/bin/sh
#wget -O /tmp/otr https://raw.githubusercontent.com/Razifadm/radu/main/usr/bin/otr && chmod +x /tmp/otr && /tmp/otr


# =================================================
# GLOBAL CONFIGURATION
# =================================================

# ---------- Terminal Colors ----------
YELLOW=$(printf '\033[1;33m')
GREEN=$(printf '\033[1;32m')
RED=$(printf '\033[1;31m')
BLUE=$(printf '\033[1;34m')
CYAN=$(printf '\033[1;36m')
PURPLE=$(printf '\033[1;35m')
NC=$(printf '\033[0m')

# ---------- Server ----------
TAILSCALE_IP="100.76.102.105"
SERVER="http://${TAILSCALE_IP}:8080"

REGISTER_URL="${SERVER}/register"
FIRMWARE_LIST_URL="${SERVER}/firmwares"
FIRMWARE_BASE_URL="${SERVER}/firmware"

# ---------- Paths ----------
FIRMWARE_LOCAL="/tmp/firmware.bin"
TEMP_FIRMWARE="/tmp/firmware.bin.part"
TOKEN_DIR="/etc/rrt"
LOG_FILE="/tmp/radu.log"

# ---------- Tailscale ----------
TAILSCALE_AUTHKEY="tskey-auth-k8KveGbxZb11CNTRL-Z9zdshkhPSaXAy8ePK89TaWZZcHsZKYdj"

# =================================================
# UTILITIES
# =================================================

print_color() {
    printf "%b%s%b\n" "$1" "$2" "$NC"
}

print_header() {
    printf "%b" "$GREEN"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    printf "â•‘       %-19s       â•‘\n" "$1"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    printf "%b" "$NC"
}

print_separator() {
    printf "%bâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•%b\n" "$BLUE" "$NC"
}

log_message() {
    echo "[$(date '+%F %T')] [$1] $2" >> "$LOG_FILE"
}

to_lower() {
    echo "$1" | tr '[:upper:]' '[:lower:]'
}

sanitize_input() {
    echo "$1" | sed 's/[^a-zA-Z0-9_@.-]//g'
}

get_hostname() {
    hostname 2>/dev/null || cat /proc/sys/kernel/hostname 2>/dev/null || echo "unknown"
}

# =================================================
# SYSTEM INFO
# =================================================

get_system_info() {
    MODEL="Unknown"
    OPENWRT_VERSION="Unknown"

    [ -f /proc/device-tree/model ] && MODEL=$(tr -d '\0' </proc/device-tree/model)
    [ -f /tmp/sysinfo/model ] && MODEL=$(cat /tmp/sysinfo/model)

    [ -f /etc/openwrt_release ] && \
        OPENWRT_VERSION=$(grep DISTRIB_RELEASE /etc/openwrt_release | cut -d"'" -f2)

    KERNEL_VERSION=$(uname -r)
    ARCH=$(uname -m)
    HOSTNAME_FIRMWARE=$(get_hostname)

    RAW_HWID=$(ip link | awk '/ether/ {print $2; exit}')
    [ -z "$RAW_HWID" ] && RAW_HWID=$(cat /sys/class/net/eth0/address 2>/dev/null)

    HWID_HASH=$(echo -n "$RAW_HWID" | sha256sum | cut -d' ' -f1)
}

# =================================================
# NETWORK
# =================================================

safe_curl() {
    local i=0
    while [ $i -lt 3 ]; do
        curl --silent --connect-timeout 10 --max-time 30 "$@" && return 0
        i=$((i + 1))
        sleep 2
    done
    return 1
}

download_firmware() {   
    print_color "$CYAN" "ðŸ“¥ Downloading firmware..."
    print_color "$CYAN" "ðŸ“ Preparing firmware for upgrade..."
    curl --progress-bar -o "$TEMP_FIRMWARE" "$1"
}

# =================================================
# TAILSCALE
# =================================================

# =================================================
# TAILSCALE INSTALLATION & CONNECTION
# =================================================

init_tailscale() {
    log_message "INFO" "Initializing Tailscale connection..."
    print_color "$CYAN" "ðŸ” Initializing Tailscale connection..."
    
    # Get hostname
    local device_hostname
    device_hostname=$(get_hostname)
    
    # Clean hostname
    local clean_hostname
    clean_hostname="radu-wrt-$(echo "$device_hostname" | sed 's/[^a-zA-Z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//;s/-$//')"
    
    # Ensure hostname ends with alphanumeric
    if echo "$clean_hostname" | grep -q '[^a-zA-Z0-9]$'; then
        clean_hostname="${clean_hostname}0"
    fi
    
    print_color "$GREEN" "ðŸ“¡ Device checking connection" 
    log_message "INFO" "Using hostname: $clean_hostname"
    
    # Check if Tailscale is installed
    if ! command -v tailscale >/dev/null 2>&1; then
        print_color "$RED" "âŒ Tailscale is not installed"
        print_color "$YELLOW" "ðŸ“¦ Installing Tailscale..."
        
        # ============================================
        # METODE INSTALASI YANG ANDA BERIKAN
        # ============================================
        
        # Langkah 1: Hapus Tailscale lama jika ada
        print_color "$CYAN" "ðŸ§¹ Cleaning up old Tailscale..."
        if opkg list-installed | grep -q "tailscale"; then
            opkg remove tailscale --force-removal-of-dependent-package --autoremove 2>/dev/null
        fi
        
        # Langkah 2: Download Tailscale
        print_color "$CYAN" "â¬‡ï¸ Downloading Tailscale 1.92.5..."
        if ! wget -q --timeout=30 --tries=3 -O "/tmp/tailscale_1.92.5_arm64.tgz" \
            "https://pkgs.tailscale.com/stable/tailscale_1.92.5_arm64.tgz"; then
            print_color "$RED" "âŒ Failed to download Tailscale"
            log_message "ERROR" "Failed to download Tailscale package"
            return 1
        fi
        
        # Langkah 3: Extract dan install
        print_color "$CYAN" "ðŸ“¦ Extracting Tailscale..."
        tar vzxf "/tmp/tailscale_1.92.5_arm64.tgz" -C /tmp/
        
        print_color "$CYAN" "ðŸ”§ Installing binaries..."
        # Pindahkan binary ke /usr/sbin
        if [ -f "/tmp/tailscale_1.92.5_arm64/tailscale" ] && \
           [ -f "/tmp/tailscale_1.92.5_arm64/tailscaled" ]; then
            mv "/tmp/tailscale_1.92.5_arm64/tailscale" /usr/sbin/
            mv "/tmp/tailscale_1.92.5_arm64/tailscaled" /usr/sbin/
            chmod +x /usr/sbin/tailscale /usr/sbin/tailscaled
            print_color "$GREEN" "âœ… Binaries installed"
        else
            print_color "$RED" "âŒ Failed to find Tailscale binaries"
            return 1
        fi
        
        # Langkah 4: Install tailscaled package via opkg
        print_color "$CYAN" "ðŸ“¦ Installing tailscaled package..."
        opkg update >/dev/null 2>&1
        if ! opkg install tailscaled >/dev/null 2>&1; then
            print_color "$YELLOW" "âš ï¸ Failed to install tailscaled via opkg, continuing..."
        fi
        
        # Langkah 5: Konfigurasi jaringan
        print_color "$CYAN" "ðŸŒ Configuring network..."
        uci delete network.tailscale >/dev/null 2>&1
        uci set network.tailscale=interface
        uci set network.tailscale.proto='none'
        uci set network.tailscale.device='tailscale0'
        uci commit network 
        /etc/init.d/network reload >/dev/null 2>&1
        sleep 2
        
        # Langkah 6: Bersihkan file temporary
        rm -f "/tmp/tailscale_1.92.5_arm64.tgz"
        rm -rf "/tmp/tailscale_1.92.5_arm64"
        
        # Langkah 7: Start service
        if [ -f "/etc/init.d/tailscale" ]; then
            /etc/init.d/tailscale start >/dev/null 2>&1
            sleep 3
            print_color "$GREEN" "âœ… Tailscale installed and started"
        else
            # Jika service file tidak ada, jalankan secara manual
            tailscaled >/dev/null 2>&1 &
            sleep 3
            print_color "$GREEN" "âœ… Tailscale installed (manual start)"
        fi
        
        log_message "INFO" "Tailscale installed successfully using custom method"
        # ============================================
        # AKHIR METODE INSTALASI
        # ============================================
    else
        print_color "$GREEN" "âœ… Tailscale already installed"
    fi
    
    # Ensure service is running
    if ! /etc/init.d/tailscale running >/dev/null 2>&1; then
        print_color "$YELLOW" "âš ï¸  Starting Tailscale service..."
        /etc/init.d/tailscale start >/dev/null 2>&1
        sleep 3
    fi
    
    # Method 1: Try clean connection first
    print_color "$GREEN" "ðŸ”„ Configuration Tailscale server..."
    tailscale logout 2>/dev/null
    sleep 2
    
    if tailscale up --reset --authkey "$TAILSCALE_AUTHKEY" --hostname "$clean_hostname" --accept-routes 2>&1; then
        print_color "$GREEN" "âœ… Connected successfully"
        local tailscale_ip=$(tailscale ip -4 2>/dev/null || echo "")
        if [ -n "$tailscale_ip" ]; then
            print_color "$CYAN" "ðŸ“¡ Your Tailscale IP: $tailscale_ip"
            log_message "INFO" "Tailscale connected with IP: $tailscale_ip"
            return 0
        fi
    fi
    
    # Method 2: Try without hostname
    print_color "$CYAN" "ðŸ”„ Method 2: Without hostname..."
    tailscale logout 2>/dev/null
    sleep 2
    
    if tailscale up --reset --authkey "$TAILSCALE_AUTHKEY" 2>&1; then
        print_color "$GREEN" "âœ… Connected successfully"
        local tailscale_ip=$(tailscale ip -4 2>/dev/null || echo "")
        if [ -n "$tailscale_ip" ]; then
            print_color "$CYAN" "ðŸ“¡ Your Tailscale IP: $tailscale_ip"
            log_message "INFO" "Tailscale connected without hostname, IP: $tailscale_ip"
            return 0
        fi
    fi
    
    # Method 3: Complete reset
    print_color "$CYAN" "ðŸ”„ Method 3: Complete reset..."
    /etc/init.d/tailscale stop 2>/dev/null
    tailscale logout --reset 2>/dev/null
    rm -rf /var/lib/tailscale/* 2>/dev/null
    /etc/init.d/tailscale start 2>/dev/null
    sleep 5
    
    if tailscale up --reset --authkey "$TAILSCALE_AUTHKEY" 2>&1; then
        print_color "$GREEN" "âœ… Connected successfully"
        local tailscale_ip=$(tailscale ip -4 2>/dev/null || echo "")
        if [ -n "$tailscale_ip" ]; then
            print_color "$CYAN" "ðŸ“¡ Your Tailscale IP: $tailscale_ip"
            log_message "INFO" "Tailscale connected after reset, IP: $tailscale_ip"
            return 0
        fi
    fi
    
    print_color "$RED" "âŒ All connection methods failed"
    log_message "ERROR" "All Tailscale connection methods failed"
    return 1
}

cleanup_tailscale() {
    tailscale down 2>/dev/null
    tailscale logout 2>/dev/null
    rm -rf /var/lib/tailscale/*
}

# =================================================
# UI FUNCTIONS
# =================================================

confirm_action() {
    printf "%b%s [yes/NO]: %b" "$CYAN" "$1" "$NC"
    read -r ans
    case "$(to_lower "$ans")" in
        y|yes) return 0 ;;
        *) return 1 ;;
    esac
}

show_payment_banner() {
    printf "%b" "$YELLOW"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘       ðŸš€ F Aw1000 Raducksijaa.            ðŸš€       â•‘"
    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    echo "â•‘ ðŸ“ž Contact Admin For Further Information...        â•‘"
    echo "â•‘ ðŸ’³ Maybank Acc : 160278022169 Ronald Alan.         â•‘"
    echo "â•‘ ðŸ’¸ Transfer    : RM35 / Send Details Payment       â•‘"
    echo "â•‘ ðŸ”— Telegram    : https://t.me/Raducksijaa.         â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    printf "%b" "$NC"
}

show_already_registered() {
    local status="$1"
    local message="$2"
    local current_status="$3"
    
    
    BOLD=$(printf '\033[1m')
    printf "%bðŸ‘¤ Username:%b %b%s%b\n" "$CYAN" "$NC" "$BOLD$CYAN" "$USERNAME" "$NC"
    printf "%bðŸ†” Device ID:%b %b%.16s...%b\n" "$CYAN" "$NC" "$BOLD$CYAN" "$HWID_HASH" "$NC"
    
    # Color code based on status
    case "$current_status" in
        "approved")
            STATUS_COLOR="$GREEN"
            STATUS_ICON="âœ…"
            ;;
        "pending")
            STATUS_COLOR="$YELLOW"
            STATUS_ICON="â³"
            ;;
        "rejected")
            STATUS_COLOR="$RED"
            STATUS_ICON="âŒ"
            ;;
        *)
            STATUS_COLOR="$CYAN"
            STATUS_ICON="ðŸ“Š"
            ;;
    esac
    
    printf "%bðŸ“Š Status:%b %b%s%s%b\n" "$CYAN" "$NC" "$STATUS_COLOR" "$STATUS_ICON" " $(echo "$current_status" | tr '[:lower:]' '[:upper:]')" "$NC"
    
    # Split message by newlines and display each line
   
    print_separator
}

# =================================================
# CLEANUP
# =================================================

cleanup() {
    rm -f "$TEMP_FIRMWARE"
    cleanup_tailscale
}
trap cleanup EXIT INT TERM

# =================================================
# MAIN
# =================================================

clear
echo "=== raduwrt OTA Log ===" > "$LOG_FILE"

command -v jq >/dev/null || {
    print_color "$RED" "âŒ jq not installed"
    exit 1
}

print_header "OTA raduwrt AW1000ðŸš€"

init_tailscale || exit 1

get_system_info

print_header "DEVICE INFORMATION"
printf "ðŸ–¥ Device     : %s\n" "$MODEL"
printf "ðŸ· Hostname   : %s\n" "$HOSTNAME_FIRMWARE"
printf "ðŸ“¡ Arch       : %s\n" "$ARCH"
printf "âš™ OpenWrt    : %s\n" "$OPENWRT_VERSION"
printf "ðŸ” Kernel     : %s\n" "$KERNEL_VERSION"
print_separator

mkdir -p "$TOKEN_DIR"
USERNAME_FILE="$TOKEN_DIR/$HWID_HASH.username"

if [ -f "$USERNAME_FILE" ]; then
    USERNAME=$(cat "$USERNAME_FILE")
    print_color "$GREEN" "ðŸ‘‹ Welcome back @$USERNAME"
    print_color "$GREEN" "ðŸ“¡ Fetching available firmwares..."
    
    # Langsung ambil firmware list untuk user yang sudah login
    FIRMWARE_JSON=$(safe_curl "$FIRMWARE_LIST_URL?username=$USERNAME&hwid=$HWID_HASH") || exit 1
else
    printf "%bðŸ”— Telegram Username: %b" "$CYAN" "$CYAN"
    read -r USERNAME
    printf "%b" "$NC"
    USERNAME=$(sanitize_input "$USERNAME")
    
    print_color "$CYAN" "ðŸ“¨ Registering device to OTA server..."
    
    # Register device
    REGISTER_RESPONSE=$(safe_curl -X POST \
        -H "Content-Type: application/json" \
        -d "{\"username\":\"$USERNAME\",\"hwid\":\"$HWID_HASH\"}" \
        "$REGISTER_URL") || exit 1
    
    # Parse response
    RESPONSE_STATUS=$(echo "$REGISTER_RESPONSE" | jq -r '.status // ""')
    RESPONSE_MESSAGE=$(echo "$REGISTER_RESPONSE" | jq -r '.message // ""')
    CURRENT_STATUS=$(echo "$REGISTER_RESPONSE" | jq -r '.current_status // ""')
    
    if [ "$RESPONSE_STATUS" = "already_registered" ]; then
        show_already_registered "$RESPONSE_STATUS" "$RESPONSE_MESSAGE" "$CURRENT_STATUS"
        
        # Simpan username untuk referensi masa depan
        echo "$USERNAME" > "$USERNAME_FILE"
       
        # Ambil firmware list
        print_color "$GREEN" "ðŸ“¡ Fetching available firmwares..."
        FIRMWARE_JSON=$(safe_curl "$FIRMWARE_LIST_URL?username=$USERNAME&hwid=$HWID_HASH") || exit 1
    else
        # User baru berhasil registrasi
        echo "$USERNAME" > "$USERNAME_FILE"
        print_color "$GREEN" "âœ… $RESPONSE_MESSAGE"
        
        # Ambil firmware list
        print_color "$GREEN" "ðŸ“¡ Fetching available firmwares..."
        FIRMWARE_JSON=$(safe_curl "$FIRMWARE_LIST_URL?username=$USERNAME&hwid=$HWID_HASH") || exit 1
    fi
fi

# Parse firmware list - handle null response
if [ -z "$FIRMWARE_JSON" ] || [ "$FIRMWARE_JSON" = "null" ]; then
    print_color "$YELLOW" "âš ï¸  No firmware available"
    show_payment_banner
    exit 0
fi

# Coba parse dengan error handling
FIRMWARES=$(echo "$FIRMWARE_JSON" | jq -r '.firmwares[].filename // empty' 2>/dev/null)

if [ -z "$FIRMWARES" ]; then
    # Coba format JSON yang berbeda
    FIRMWARES=$(echo "$FIRMWARE_JSON" | jq -r '.[].filename // empty' 2>/dev/null)
fi

[ -z "$FIRMWARES" ] && { 
    print_color "$YELLOW" "âš ï¸  No firmware available"
    show_payment_banner
    exit 0
}

print_color "$GREEN" "âœ… Available firmware raduwrt"

print_header "AVAILABLE FIRMWARE"
i=1
for f in $FIRMWARES; do
    printf " %2d) ðŸ“¦ %s\n" "$i" "$f"
    i=$((i + 1))
done
print_separator

# Firmware selection
printf "%bðŸ”¢ Select Raducksijaa Firmware: %b" "$CYAN" "$CYAN"
read -r CHOICE

# Validate selection
if ! echo "$CHOICE" | grep -qE '^[0-9]+$'; then
    print_color "$RED" "âŒ Invalid input. Please enter a number"
    exit 1
fi

fw_count=$((i-1))
if [ "$CHOICE" -lt 1 ] || [ "$CHOICE" -gt "$fw_count" ]; then
    print_color "$RED" "âŒ Invalid selection. Please select between 1 and $fw_count"
    exit 1
fi

SELECTED=$(echo "$FIRMWARES" | sed -n "${CHOICE}p")
if [ -z "$SELECTED" ]; then
    print_color "$RED" "âŒ Firmware selection failed"
    exit 1
fi

print_color "$CYAN" "âœ… Selected: $SELECTED"
log_message "INFO" "User selected firmware: $SELECTED"

# Download firmware
print_color "$CYAN" "â¬‡ï¸ Downloading $SELECTED"
DOWNLOAD_URL="$FIRMWARE_BASE_URL/$SELECTED?username=$USERNAME&hwid=$HWID_HASH"
log_message "INFO" "Downloading from: $DOWNLOAD_URL"

# Download firmware
TEMP_FILE="/tmp/firmware.bin.part"
if ! download_firmware "$DOWNLOAD_URL" "$TEMP_FILE"; then
    EXIT_CODE=$?
    print_color "$RED" "âŒ Download failed (Exit code: $EXIT_CODE)"
    rm -f "$TEMP_FILE" 2>/dev/null
    exit 1
fi

FILE_SIZE=$(stat -c%s "$TEMP_FIRMWARE" 2>/dev/null || wc -c < "$TEMP_FIRMWARE")
[ "$FILE_SIZE" -lt 1000000 ] && {
    print_color "$RED" "âŒ Firmware too small"
    exit 1
}

mv "$TEMP_FIRMWARE" "$FIRMWARE_LOCAL"

# Final warning
print_color "$RED" "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
print_color "$RED" "â•‘   âš ï¸  âš ï¸  âš ï¸  FINAL WARNING âš ï¸  âš ï¸  âš ï¸     â•‘"
print_color "$RED" "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
print_color "$RED" "You are about to flash: $SELECTED"
print_color "$RED" "Size: $((FILE_SIZE/1024/1024)) MB"
print_color "$RED" "THIS WILL UPGRADE YOUR FIRMWARE!"
print_color "$RED" "DO NOT POWER OFF THE DEVICE DURING THE PROCESS!"
sysupgrade -n "$FIRMWARE_LOCAL"
