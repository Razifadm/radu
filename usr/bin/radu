#!/bin/sh

echo "This process will install luci-app-netstats"

# ğŸ§¹ Remove opkg lock kalau tersangkut
rm -f /var/lock/opkg.lock

# ğŸ”„ Update software list
opkg update 
opkg install curl
echo "Updating software list"

# âŒ Remove vnstat2 related packages
echo "Removing vnstat2 packages..."
opkg remove --force-depends --autoremove vnstat vnstat2 vnstati2 luci-app-vnstat2 luci-app-vnstat luci-app-netstat

# ğŸ§¹ Second lock cleanup
rm -f /var/lock/opkg.lock

# ğŸ“¦ Download new luci-app-netstat.ipk
echo "Downloading luci-app-netstat.ipk..."
wget -O /etc/luci-app-netstat.ipk \
https://raw.githubusercontent.com/Razifadm/radu/ipk/luci-app-netstat.ipk

# âš™ï¸ Install the new package
echo "Installing netstat..."
opkg install /etc/luci-app-netstat.ipk

# ğŸ—‘ï¸ Remove the installer to save space
rm -f /etc/luci-app-netstat.ipk

# ğŸ§° Auto-fix configs & cleanup
echo "Running auto-fix..."
# Backup old config
[ -f /etc/config/vnstat ] && cp /etc/config/vnstat /etc/config/vnstat.bak
[ -f /etc/vnstat.conf ] && cp /etc/vnstat.conf /etc/vnstat.conf.bak

# Replace with new config if available
[ -f /etc/config/vnstat-opkg ] && mv /etc/config/vnstat-opkg /etc/config/vnstat
[ -f /etc/vnstat.conf-opkg ] && mv /etc/vnstat.conf-opkg /etc/vnstat.conf

# Cleanup leftovers
rm -f /etc/config/vnstat-opkg /etc/vnstat.conf-opkg

# Ensure defaults file exists
[ ! -f /etc/uci-defaults/vnstat ] && touch /etc/uci-defaults/vnstat

#set database direction
sed -i "s/DatabaseDir \"\/var\/lib\/vnstat\"/DatabaseDir \"\/etc\/vnstat\"/g" /etc/vnstat.conf
sed -i 's/eth0/wwan0_1/g' /etc/vnstat.conf

# Restart services
/etc/init.d/vnstat enable
/etc/init.d/vnstat restart

# Reload LuCI cache
rm -rf /tmp/luci-indexcache /tmp/luci-modulecache/*
/etc/init.d/rpcd restart

echo "=== luci-app-netstat installed, configured & ready! ==="

# ğŸ”š Auto remove installer itself
rm -f "$0"
