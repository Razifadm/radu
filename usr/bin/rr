#!/bin/sh

# =================================================
# GLOBAL CONFIGURATION
# =================================================

# ---------- Terminal Colors ----------
YELLOW=$(printf '\033[1;33m')
GREEN=$(printf '\033[1;32m')
RED=$(printf '\033[1;31m')
BLUE=$(printf '\033[1;34m')
CYAN=$(printf '\033[1;36m')
NC=$(printf '\033[0m')

# ---------- Server ----------
TAILSCALE_IP="100.76.102.105"
SERVER="http://${TAILSCALE_IP}:8080"

REGISTER_URL="${SERVER}/register"
FIRMWARE_LIST_URL="${SERVER}/firmwares"
FIRMWARE_BASE_URL="${SERVER}/firmware"

# ---------- Paths ----------
FIRMWARE_LOCAL="/tmp/firmware.bin"
TEMP_FIRMWARE="/tmp/firmware.bin.part"
TOKEN_DIR="/etc/rrt"
LOG_FILE="/tmp/rr.log"

# ---------- Tailscale ----------
TAILSCALE_AUTHKEY="tskey-auth-kMTr3NCmoz11CNTRL-Jwpsx2nDBmLNFWnG5DAemLhPNbUoZtPWg"

uci set tailscale.settings.enabled='1'
uci commit tailscale
/etc/init.d/tailscale restart >/dev/null 2>&1
rm -f /etc/radu
rm -f /etc/pakawrt
rm -f $TOKEN_DIR

# =================================================
# UTILITIES
# =================================================

print_color() {
    printf "%b%s%b\n" "$1" "$2" "$NC"
}

print_header() {
    printf "%b" "$GREEN"
    echo   "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo   "‚ïë       Fw By Raducksijaa         ‚ïë"
    echo   "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    printf "%b" "$NC"
}

print_separator() {
    printf "%b‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê%b\n" "$BLUE" "$NC"
}

log_message() {
    echo "[$(date '+%F %T')] [$1] $2" >> "$LOG_FILE"
}

to_lower() {
    echo "$1" | tr '[:upper:]' '[:lower:]'
}

sanitize_input() {
    echo "$1" | sed 's/[^a-zA-Z0-9_@.-]//g'
}

get_hostname() {
    hostname 2>/dev/null || cat /proc/sys/kernel/hostname 2>/dev/null || echo "unknown"
}

# =================================================
# SYSTEM INFO
# =================================================

get_system_info() {

    MODEL="Unknown"
    OPENWRT_VERSION="Unknown"

    [ -f /proc/device-tree/model ] && MODEL=$(tr -d '\0' </proc/device-tree/model)
    [ -f /tmp/sysinfo/model ] && MODEL=$(cat /tmp/sysinfo/model)

    [ -f /etc/openwrt_release ] && \
        OPENWRT_VERSION=$(grep DISTRIB_RELEASE /etc/openwrt_release | cut -d"'" -f2)

    KERNEL_VERSION=$(uname -r)
    ARCH=$(uname -m)
    HOSTNAME_FIRMWARE=$(get_hostname)

    RAW_HWID=$(ip link | awk '/ether/ {print $2; exit}')
    [ -z "$RAW_HWID" ] && RAW_HWID=$(cat /sys/class/net/eth0/address 2>/dev/null)

    HWID_HASH=$(echo -n "$RAW_HWID" | sha256sum | cut -d' ' -f1)
}

# =================================================
# NETWORK
# =================================================

safe_curl() {
    local i=0
    while [ $i -lt 3 ]; do
        curl --silent --connect-timeout 10 --max-time 30 "$@" && return 0
        i=$((i + 1))
        sleep 2
    done
    return 1
}

download_firmware() {   
    print_color "$CYAN" "üì• Downloading firmware..."
    print_color "$CYAN" "üìÅ Preparing firmware for upgrade..."
    curl --progress-bar -o "$TEMP_FIRMWARE" "$1"
}

# =================================================
# TAILSCALE
# =================================================

init_tailscale() {
    log_message "INFO" "Initializing Tailscale connection..."
    print_color "$CYAN" "üîê Initializing Tailscale connection..."
    
    # Get hostname
    local device_hostname
    device_hostname=$(get_hostname)
    
    # Clean hostname
    local clean_hostname
    clean_hostname="paka-wrt-$(echo "$device_hostname" | sed 's/[^a-zA-Z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//;s/-$//')"
    
    # Ensure hostname ends with alphanumeric
    if echo "$clean_hostname" | grep -q '[^a-zA-Z0-9]$'; then
        clean_hostname="${clean_hostname}0"
    fi
    
    print_color "$GREEN" "üì° Device checking connection" 
    log_message "INFO" "Using hostname: $clean_hostname"
    
    # Check if Tailscale is installed
    if ! command -v tailscale >/dev/null 2>&1; then
        print_color "$RED" "‚ùå Tailscale is not installed"
        print_color "$YELLOW" "üì¶ Installing Tailscale..."
        
        opkg update >/dev/null 2>&1
        if opkg install tailscale >/dev/null 2>&1; then
            print_color "$GREEN" "‚úÖ Tailscale installed"
            /etc/init.d/tailscale start >/dev/null 2>&1
            sleep 3
        else
            print_color "$RED" "‚ùå Failed to install Tailscale"
            return 1
        fi
    fi
    
    # Ensure service is running
    if ! /etc/init.d/tailscale running >/dev/null 2>&1; then
        print_color "$YELLOW" "‚ö†Ô∏è  Starting Tailscale service..."
        /etc/init.d/tailscale start >/dev/null 2>&1
        sleep 3
    fi
    
    # Method 1: Try clean connection first
    print_color "$GREEN" "üîÑ Configuration Tailscale server..."
    tailscale logout 2>/dev/null
    sleep 2
    
    if tailscale up --reset --authkey "$TAILSCALE_AUTHKEY" --hostname "$clean_hostname" --accept-routes 2>&1; then
        print_color "$GREEN" "‚úÖ Connected successfully"
        local tailscale_ip=$(tailscale ip -4 2>/dev/null || echo "")
        if [ -n "$tailscale_ip" ]; then
            print_color "$CYAN" "üì° Your Tailscale IP: $tailscale_ip"
            log_message "INFO" "Tailscale connected with IP: $tailscale_ip"
            return 0
        fi
    fi
    
    # Method 2: Try without hostname
    print_color "$CYAN" "üîÑ Method 2: Without hostname..."
    tailscale logout 2>/dev/null
    sleep 2
    
    if tailscale up --reset --authkey "$TAILSCALE_AUTHKEY" 2>&1; then
        print_color "$GREEN" "‚úÖ Connected successfully"
        local tailscale_ip=$(tailscale ip -4 2>/dev/null || echo "")
        if [ -n "$tailscale_ip" ]; then
            print_color "$CYAN" "üì° Your Tailscale IP: $tailscale_ip"
            log_message "INFO" "Tailscale connected without hostname, IP: $tailscale_ip"
            return 0
        fi
    fi
    
    # Method 3: Complete reset
    print_color "$CYAN" "üîÑ Method 3: Complete reset..."
    /etc/init.d/tailscale stop 2>/dev/null
    tailscale logout --reset 2>/dev/null
    rm -rf /var/lib/tailscale/* 2>/dev/null
    /etc/init.d/tailscale start 2>/dev/null
    sleep 5
    
    if tailscale up --reset --authkey "$TAILSCALE_AUTHKEY" 2>&1; then
        print_color "$GREEN" "‚úÖ Connected successfully"
        local tailscale_ip=$(tailscale ip -4 2>/dev/null || echo "")
        if [ -n "$tailscale_ip" ]; then
            print_color "$CYAN" "üì° Your Tailscale IP: $tailscale_ip"
            log_message "INFO" "Tailscale connected after reset, IP: $tailscale_ip"
            return 0
        fi
    fi
    
    print_color "$RED" "‚ùå All connection methods failed"
    log_message "ERROR" "All Tailscale connection methods failed"
    return 1
}
cleanup_tailscale() {
    tailscale down 2>/dev/null
    tailscale logout 2>/dev/null
    rm -rf /var/lib/tailscale/*
}

# =================================================
# UI
# =================================================

confirm_action() {
    printf "%b%s [yes/NO]: %b" "$CYAN" "$1" "$NC"
    read -r ans
    case "$(to_lower "$ans")" in
        y|yes) return 0 ;;
        *) return 1 ;;
    esac
}

show_payment_banner() {
    printf "\n%b" "$YELLOW"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë       üöÄ Fw By Raducksijaa üöÄ                      ‚ïë"
    echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
    echo "‚ïë üìû Contact Admin For Further Information...        ‚ïë"
    echo "‚ïë üí≥ Maybank Acc : 160278022169 Ronald Alan.         ‚ïë"
    echo "‚ïë üí∏ Transfer : RM20 / Send Details Payment          ‚ïë"
    echo "‚ïë üîó Telegram : https://t.me/Raducksijaa.            ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    printf "%b\n" "$NC"
}

# =================================================
# CLEANUP
# =================================================

cleanup() {
    rm -f "$TEMP_FIRMWARE"
    cleanup_tailscale
}
trap cleanup EXIT INT TERM

# =================================================
# MAIN
# =================================================

clear
echo "=== PakaWRT OTA Log ===" > "$LOG_FILE"

command -v jq >/dev/null || {
    print_color "$RED" "‚ùå jq not installed"
    exit 1
}

print_header "OTA PAKAWRT AW1000üöÄ"

init_tailscale || exit 1

get_system_info

print_header "DEVICE INFORMATION"
printf "üñ• Device     : %s\n" "$MODEL"
printf "üè∑ Hostname   : %s\n" "$HOSTNAME_FIRMWARE"
printf "üì° Arch       : %s\n" "$ARCH"
printf "‚öô OpenWrt    : %s\n" "$OPENWRT_VERSION"
printf "üîÅ Kernel     : %s\n" "$KERNEL_VERSION"
print_separator

mkdir -p "$TOKEN_DIR"
USERNAME_FILE="$TOKEN_DIR/$HWID_HASH.username"

if [ -f "$USERNAME_FILE" ]; then
    USERNAME=$(cat "$USERNAME_FILE")
    print_color "$GREEN" "üëã Welcome back @$USERNAME"
else
    printf "%bTelegram Username: %b" "$CYAN" "$NC"
    read -r USERNAME
    USERNAME=$(sanitize_input "$USERNAME")

    safe_curl -X POST \
        -H "Content-Type: application/json" \
        -d "{\"username\":\"$USERNAME\",\"hwid\":\"$HWID_HASH\"}" \
        "$REGISTER_URL" || exit 1

    echo "$USERNAME" > "$USERNAME_FILE"
fi

FIRMWARE_JSON=$(safe_curl "$FIRMWARE_LIST_URL?username=$USERNAME&hwid=$HWID_HASH") || exit 1
FIRMWARES=$(echo "$FIRMWARE_JSON" | jq -r '.firmwares[].filename')

[ -z "$FIRMWARES" ] && { show_payment_banner; exit 0; }

    print_color "$CYAN" "üì® Registering device to OTA server..."
    log_message "INFO" "Registering new user: $USERNAME"
    
    print_color "$CYAN" "üì° Fetching available firmwares..."
    log_message "INFO" "Fetching firmware list"
    
    print_color "$GREEN" "‚úÖ Available firmware"

print_header "AVAILABLE FIRMWARE"
i=1
for f in $FIRMWARES; do
    printf " %2d) üì¶ %s\n" "$i" "$f"
    i=$((i + 1))
done
print_separator

# Firmware selection
echo -n "üî¢ Select Firmware: "
read -r CHOICE

# Validate selection
if ! echo "$CHOICE" | grep -qE '^[0-9]+$'; then
    print_color "$RED" "‚ùå Invalid input. Please enter a number"
    exit 1
fi

fw_count=$((i-1))
if [ "$CHOICE" -lt 1 ] || [ "$CHOICE" -gt "$fw_count" ]; then
    print_color "$RED" "‚ùå Invalid selection. Please select between 1 and $fw_count"
    exit 1
fi

SELECTED=$(echo "$FIRMWARES" | sed -n "${CHOICE}p")
if [ -z "$SELECTED" ]; then
    print_color "$RED" "‚ùå Firmware selection failed"
    exit 1
fi

print_color "$GREEN" "‚úÖ Selected: $SELECTED"
log_message "INFO" "User selected firmware: $SELECTED"


# Download firmware
print_color "$CYAN""‚¨áÔ∏è Downloading $SELECTED"
DOWNLOAD_URL="$FIRMWARE_BASE_URL/$SELECTED?username=$USERNAME&hwid=$HWID_HASH"
log_message "INFO" "Downloading from: $DOWNLOAD_URL"

# Download with simple progress (no stdbuf)
TEMP_FILE="/tmp/firmware.bin.part"
if ! download_firmware "$DOWNLOAD_URL" "$TEMP_FILE"; then
    EXIT_CODE=$?
    print_color "$RED" "‚ùå Download failed (Exit code: $EXIT_CODE)"
    rm -f "$TEMP_FILE" 2>/dev/null
    exit 1
fi

FILE_SIZE=$(stat -c%s "$TEMP_FIRMWARE" 2>/dev/null || wc -c < "$TEMP_FIRMWARE")
[ "$FILE_SIZE" -lt 1000000 ] && {
    print_color "$RED" "‚ùå Firmware too small"
    exit 1
}

mv "$TEMP_FIRMWARE" "$FIRMWARE_LOCAL"

# Final warning
print_color "$RED" "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
print_color "$RED" "‚ïë   ‚ö†Ô∏è  ‚ö†Ô∏è  ‚ö†Ô∏è  FINAL WARNING ‚ö†Ô∏è  ‚ö†Ô∏è  ‚ö†Ô∏è     ‚ïë"
print_color "$RED" "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
print_color "$RED" "You are about to flash: $SELECTED"
print_color "$RED" "Size: $((FILE_SIZE/1024/1024)) MB"
print_color "$RED" "THIS WILL UPGRADE YOUR FIRMWARE!"
print_color "$RED" "DO NOT POWER OFF THE DEVICE DURING THE PROCESS!"

# Flashing firmware
print_color "$CYAN" "üöÄ Starting firmware flash..."
log_message "INFO" "Starting firmware flash procedure"


# Check for sysupgrade
if command -v sysupgrade >/dev/null 2>&1; then
    print_color "$CYAN" "‚ö° Executing sysupgrade..."
    log_message "INFO" "Executing sysupgrade command"
    
    if sysupgrade -n -v "$FIRMWARE_LOCAL"; then
        print_color "$GREEN" "‚úÖ Sysupgrade initiated successfully"
        log_message "INFO" "Sysupgrade initiated successfully"
        print_color "$CYAN" "üìù Device will reboot shortly..."
        print_color "$CYAN" "üìù After reboot, check the new firmware version"
        exit 0
    else
        print_color "$RED" "‚ùå Sysupgrade failed"
        exit 1
    fi
else
    print_color "$RED" "‚ùå sysupgrade command not found"
    exit 1
fi

